<html>
  <head>
    <link rel="stylesheet" href="//code.jquery.com/qunit/qunit-1.15.0.css">
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
  </head>
  <body>
    <div id="qunit"></div>
    <div id="qunit-fixture"></div>

    <script src="//code.jquery.com/qunit/qunit-1.15.0.js"></script>

    <script>
      // Fuck, API changed.
      // "phone" is optional,
      // "location" is ignored, computed serverside.
      var person1 = {"name": "Richard", "postal": "618656"};
      var person2 = {"name": "Yatish",  "postal": "117417", "phone": 5678};

      QUnit.asyncTest("/doSearch with some input", function( assert ) {
        expect( 2 ); // number of assertions in this async test.

        $.post("../doSearch",
               JSON.stringify({
                 "people": [person1, person2]
               }),
               gotBackFromDoSearch);

        function gotBackFromDoSearch(response) {
          console.log("** /doSearch callback **");
          console.log("RES:" + response);
          console.log(JSON.stringify(response));

          var searchId = response.searchId;

          $.get("../search/" + searchId + "/people",
                "",
                gotBackFromGetSearchPeople);
        }

        function gotBackFromGetSearchPeople(response) {
          console.log("** /search/#SearchId/people callback **");
          console.log("RES:" + response);
          console.log(JSON.stringify(response));

          assert.ok( !response.error, "response contains no error, search with given id exists" );
          assert.equal( response.people.length, 2, "both people correctly input to search" );

          QUnit.start();
        }
      });

      var testGeocode = [{"postcode": "117417", "expected": {"lat": 1.295053, "lng": 103.773846}},
                         {"postcode": "088278", "expected": {"lat": 1.274452, "lng": 103.841691}},
                         {"postcode": "138595", "expected": {"lat": 1.306481, "lng": 103.773701}}];
      testGeocode.forEach(function(geocodeInput) {
        var inputPostcode = geocodeInput.postcode;
        QUnit.asyncTest("/geocode for " + inputPostcode, function( assert ) {
          expect( 2 ); // number of assertions in this async test.

          // Check to 3 or 4 decimal places, should be okay.

          $.get("../geocode/" + inputPostcode,
                "",
                gotBackFromGeocode);

          // TODO(?): for get ../geocode postcode=117417
          // * (Nginx) rewrite rules..

          function gotBackFromGeocode(response) {
            var lat = response.lat;
            var lng = response.lng;

            var expectedLat = geocodeInput.expected.lat;
            var expectedLng = geocodeInput.expected.lng;

            var acceptableError = 0.001;

            assert.ok( Math.abs( expectedLat - lat) < acceptableError, "lat okay" );
            assert.ok( Math.abs( expectedLng - lng) < acceptableError, "lng okay" );

            QUnit.start();
          }
        });
      });
    </script>
  </body>
</html>
